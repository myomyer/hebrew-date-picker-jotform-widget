<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <title>Hebrew Date (from Civil)</title>
  <script src="//js.jotform.com/JotFormCustomWidget.min.js"></script>
  <style>
    body {
      font-family: var(--font-family, inherit);
      font-size: var(--font-size, inherit);
      color: var(--font-color, inherit);
      background: var(--form-background, transparent);
      margin: 0;
      padding: 6px;
    }
    label {
      font-weight: bold;
      font-size: 0.9em;
      margin-right: 6px;
    }
    input[type="checkbox"] {
      margin-left: 6px;
    }
    #hebrewOutput {
      display: inline-block;
      margin-top: 10px;
      padding: 4px 8px;
      background: #f7f7f7;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1em;
      direction: rtl;
    }
  </style>
</head>
<body>
  <div>
    <label>
      <input type="checkbox" id="afterSunset"> After Sunset
    </label>
  </div>

  <div id="hebrewOutput">Waiting for Civil Date…</div>

  <script>
    const sunsetCheck = document.getElementById('afterSunset');
    const hebrewOutput = document.getElementById('hebrewOutput');

    let lastCivil = null;
    let sourceField = ""; // configured from widget settings

    // Hebrew numeral converter
    function toHebrewNumber(num) {
      const map = {
        1:"א",2:"ב",3:"ג",4:"ד",5:"ה",6:"ו",7:"ז",8:"ח",9:"ט",
        10:"י",20:"כ",30:"ל",40:"מ",50:"נ",60:"ס",70:"ע",80:"פ",90:"צ",
        100:"ק",200:"ר",300:"ש",400:"ת"
      };
      let parts = [];
      let n = num;
      [400,300,200,100].forEach(v=>{
        while (n >= v) { parts.push(map[v]); n -= v; }
      });
      [90,80,70,60,50,40,30,20,10].forEach(v=>{
        while (n >= v) { parts.push(map[v]); n -= v; }
      });
      if (n > 0) parts.push(map[n]);
      let str = parts.join("");
      if (str === "יה") str = "טו";
      if (str === "יו") str = "טז";
      if (str.length === 1) return str + "׳";
      if (str.length > 1) return str.slice(0,-1) + "״" + str.slice(-1);
      return str;
    }

    function toShortHebrewYear(year) {
      return toHebrewNumber(year % 1000);
    }

    function formatHebrewDate(hd, hm, hy) {
      return `${toHebrewNumber(hd)} ${hm} ${toShortHebrewYear(hy)}`;
    }

    // Convert Civil date string to Hebrew
    async function convertToHebrew(civilDate) {
      if (!civilDate) return;
      let dateToUse = civilDate;

      // Apply after-sunset bump
      if (sunsetCheck.checked) {
        let d = new Date(civilDate);
        d.setDate(d.getDate() + 1);
        dateToUse = d.toISOString().split("T")[0];
      }

      const url = `https://www.hebcal.com/converter?cfg=json&date=${dateToUse}&g2h=1&strict=1`;
      try {
        const res = await fetch(url);
        const data = await res.json();
        const hebString = formatHebrewDate(data.hd, data.hm, data.hy);

        hebrewOutput.textContent = hebString;

        if (typeof JFCustomWidget !== "undefined") {
          JFCustomWidget.sendData({
            value: hebString,
            valid: true
          });
        }
      } catch (err) {
        hebrewOutput.textContent = "Error fetching Hebrew date";
      }
    }

    // Jotform widget integration
    if (typeof JFCustomWidget !== "undefined") {
      // Get widget settings
      JFCustomWidget.subscribe("ready", function(data) {
        if (data && data.sourceField) {
          sourceField = data.sourceField;
        }
      });

      // Listen for Civil Date updates
      JFCustomWidget.subscribe("populate", function(data) {
        if (!data) return;

        // If a specific field is configured, only listen to that
        if (sourceField && data.name !== sourceField) return;

        if (data.value) {
          lastCivil = data.value;
          convertToHebrew(lastCivil);
        }
      });
    }

    // Recalculate if After Sunset toggled
    sunsetCheck.addEventListener("change", () => {
      if (lastCivil) convertToHebrew(lastCivil);
    });
  </script>
</body>
</html>

